<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>訂單紀錄</title>
  <style>
    /* 黑底白字風格 */
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      padding: 0;
      background-color: black;
      color: white;
      text-align: center;
      user-select: none;
      overflow-x: hidden; /* 防止水平方向滾動 */
      -webkit-overflow-scrolling: touch;
    }
    /* 內容容器 */
    #contentContainer {
      width: 90%;
      margin: 0 auto 20px;
      padding-bottom: 20px;
      background-color: black;
      overflow: hidden;
      position: relative;
    }
    /* 每筆訂單區塊 */
    .orderBlock {
      border: 1px solid orange;
      border-radius: 3px;
      margin-bottom: 15px;
      padding: 10px;
      position: relative;
      transition: transform 0.3s, opacity 0.3s;
      background-color: black;
    }
    /* 被選取的訂單放大並置於上層 */
    .orderBlock.selected {
      transform: scale(1.05);
      z-index: 1000;
    }
    /* 訂單標題容器 */
    .orderHeaderContainer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      margin-bottom: 5px;
    }
    /* 訂單表格 */
    table {
      width: 100%;
      background-color: black;
      color: white;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 3px;
      margin-bottom: 5px;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    table th {
      background-color: orange;
      color: black;
    }
    thead tr th:first-child {
      border-top-left-radius: 3px;
    }
    thead tr th:last-child {
      border-top-right-radius: 3px;
    }
    /* 備忘錄 */
    .voiceMemo {
      text-align: left;
      color: orange;
      padding: 5px;
      background-color: black;
      cursor: default;
    }
  </style>
</head>
<body>
  <br><br>
  <div id="contentContainer">
    <!-- 訂單區塊將由 JavaScript 動態加入 -->
  </div>
  <script>
    let orderHistory = [];
    
    // 讀取與儲存訂單記錄
    function loadOrderHistory() {
      const historyJSON = localStorage.getItem("orderHistory");
      if (historyJSON) {
        orderHistory = JSON.parse(historyJSON);
      } else {
        // 若沒有資料則建立預設範例
        orderHistory = [
          {
            orders: [
              { dish: "便當", quantity: "1", remark: "微辣", price: "80" },
              { dish: "飲料", quantity: "2", remark: "", price: "30" }
            ],
            voiceMemo: "中午訂單"
          },
          {
            orders: [
              { dish: "咖啡", quantity: "1", remark: "無糖", price: "50" },
              { dish: "蛋糕", quantity: "1", remark: "草莓", price: "100" }
            ],
            voiceMemo: "下午點心"
          }
        ];
        saveOrderHistory();
      }
    }
    function saveOrderHistory() {
      localStorage.setItem("orderHistory", JSON.stringify(orderHistory));
    }
    
    // 渲染訂單紀錄
    function renderOrderHistory() {
      const container = document.getElementById("contentContainer");
      container.innerHTML = "";
      if (orderHistory.length === 0) {
        container.innerHTML = "<p>沒有訂單資料</p>";
        return;
      }
      orderHistory.forEach((order, index) => {
        const orderBlock = document.createElement("div");
        orderBlock.classList.add("orderBlock");
        orderBlock.dataset.orderIndex = index;
        
        // 訂單標題
        const headerContainer = document.createElement("div");
        headerContainer.classList.add("orderHeaderContainer");
        const headerLeft = document.createElement("span");
        headerLeft.innerText = "訂單 #" + (index + 1);
        let total = 0;
        order.orders.forEach(item => {
          const qty = parseFloat(item.quantity);
          const price = parseFloat(item.price);
          if (!isNaN(qty) && !isNaN(price)) {
            total += qty * price;
          }
        });
        const headerRight = document.createElement("span");
        headerRight.innerText = "總金額：" + total + " 元";
        headerContainer.appendChild(headerLeft);
        headerContainer.appendChild(headerRight);
        orderBlock.appendChild(headerContainer);
        
        // 訂單表格
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        ["品項", "份數", "備註", "單價"].forEach(text => {
          const th = document.createElement("th");
          th.innerText = text;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        order.orders.forEach(item => {
          const row = document.createElement("tr");
          ["dish", "quantity", "remark", "price"].forEach(prop => {
            const td = document.createElement("td");
            td.innerText = item[prop];
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        orderBlock.appendChild(table);
        
        // 備忘錄
        const memoDiv = document.createElement("div");
        memoDiv.classList.add("voiceMemo");
        memoDiv.innerText = order.voiceMemo;
        orderBlock.appendChild(memoDiv);
        
        // 觸控事件：點選後僅將該筆訂單放大
        orderBlock.addEventListener("touchend", function(e) {
          // 防止下滑後瀏覽器自動重新整理（pull-to-refresh）
          e.preventDefault();
          // 取消其他已選取的訂單
          document.querySelectorAll(".orderBlock.selected").forEach(block => {
            if (block !== orderBlock) {
              block.classList.remove("selected");
            }
          });
          // 切換目前選取的訂單
          if (orderBlock.classList.contains("selected")) {
            orderBlock.classList.remove("selected");
          } else {
            orderBlock.classList.add("selected");
          }
        });
        
        container.appendChild(orderBlock);
      });
    }
    
    // 防止下拉刷新：若只有一指滑動時，阻止預設行為
    document.addEventListener("touchmove", function(e) {
      if (e.touches.length === 1) {
        e.preventDefault();
      }
    }, { passive: false });
    
    // 初始化
    loadOrderHistory();
    renderOrderHistory();
  </script>
</body>
</html>