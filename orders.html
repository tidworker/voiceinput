<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>訂單列表</title>
  <style>
    /* 與點餐系統相同的外觀設定 */
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      padding: 0;
      background-color: black;
      color: white;
      text-align: center;
    }
    /* 按鈕樣式 */
    #resetButton {
      background-color: orange;
      color: black;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
    }
    /* 統一內容區 */
    #contentContainer {
      width: 90%;
      height: 340px;
      margin: 20px auto;
      overflow-y: auto;
      background-color: black;
    }
    /* 訂單表格樣式 */
    table {
      width: 100%;
      background-color: black;
      color: white;
      border-collapse: collapse;
      border: 1px solid white;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border: 1px solid white;
    }
    thead tr th {
      background-color: orange;
      color: black;
    }
    /* 總金額文字 */
    #totalAmount {
      color: white;
      font-size: 18px;
      margin-top: 10px;
    }
    /* 語音備忘錄區，顯示訂單編號 */
    #voiceOutput {
      margin-top: 10px;
      text-align: left;
      color: orange;
      padding: 10px;
      border: 1px solid orange;
    }
    /* 圖片 */
    img {
      max-width: 100%;
      height: auto;
    }
    /* 紅色浮動按鈕 */
    #voiceButton {
      position: fixed;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      width: 70px;
      height: 70px;
      background-color: red;
      border: 5px solid white;
      border-radius: 50%;
      cursor: pointer;
      z-index: 3000;
    }
    /* 左右方形按鈕（保留原系統樣式） */
    #decreaseButton,
    #increaseButton {
      position: fixed;
      bottom: 50px;
      width: 150px;
      height: 100px;
      background-color: black;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }
    /* 左側按鈕位置 */
    #decreaseButton {
      left: calc(50% - 35px - 150px - 10px);
    }
    /* 右側按鈕位置 */
    #increaseButton {
      left: calc(50% + 35px + 10px);
    }
    /* 防止按鈕內文字被選取 */
    #voiceButton, #voiceButton * {
      user-select: none;
    }
  </style>
</head>
<body>
  <br />
  <img src="3.png" alt="圖片" />

  <!-- 訂單與語音備忘錄內容區 -->
  <div id="contentContainer">
    <table id="orderTable">
      <thead>
        <tr>
          <th>品項</th>
          <th>份數</th>
          <th>備註</th>
          <th>單價</th>
        </tr>
      </thead>
      <tbody>
        <!-- 訂單資料將從 localStorage 載入 -->
      </tbody>
    </table>
    <!-- 語音備忘錄區，同時顯示訂單編號 -->
    <div id="voiceOutput"></div>
  </div>

  <p id="totalAmount">總金額：0 元</p>

  <!-- 保留左右方形按鈕（功能可再調整） -->
  <button id="decreaseButton"></button>
  <!-- 紅色浮動按鈕 -->
  <button id="voiceButton"></button>
  <button id="increaseButton"></button>

  <script>
    // 若 localStorage 中沒有訂單編號，則產生一個並儲存
    function ensureOrderId() {
      let orderId = localStorage.getItem("orderId");
      if (!orderId) {
        orderId = Date.now().toString();
        localStorage.setItem("orderId", orderId);
      }
      return orderId;
    }

    // 顯示訂單編號於語音備忘錄區
    function showOrderId() {
      let orderId = ensureOrderId();
      let memoDiv = document.getElementById("voiceOutput");
      memoDiv.innerText = "訂單編號：" + orderId;
    }

    // 讀取 localStorage 中的訂單資料並更新表格與總金額
    function loadOrders() {
      let ordersStr = localStorage.getItem("orders");
      let tbody = document.getElementById("orderTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      let total = 0;
      if (ordersStr) {
        let orders = JSON.parse(ordersStr);
        orders.forEach((order) => {
          let row = tbody.insertRow();
          let cellDish = row.insertCell();
          cellDish.innerText = order.dish;
          let cellQuantity = row.insertCell();
          cellQuantity.innerText = order.quantity;
          let cellRemark = row.insertCell();
          cellRemark.innerText = order.remark;
          let cellPrice = row.insertCell();
          cellPrice.innerText = order.price;
          total += parseFloat(order.quantity) * parseFloat(order.price);
        });
      }
      document.getElementById("totalAmount").innerText = "總金額：" + total + " 元";
    }

    window.onload = function() {
      showOrderId();
      loadOrders();
    };

    /* 紅色浮動按鈕手勢控制 */
    // 若拖曳紅色按鈕向左超過 30px，放開時跳轉至 index.html
    let startX = 0, startY = 0;
    let swipeToggled = false;
    let gestureDirection = "";
    let gestureStartTime = 0;
    const voiceButton = document.getElementById("voiceButton");
    voiceButton.style.transform = "translate(-50%, 0)";

    function updateButtonPosition(currentX, currentY) {
      let deltaX = currentX - startX;
      let deltaY = currentY - startY;
      if (!swipeToggled && Math.abs(deltaX) > 30 && Math.abs(deltaX) > Math.abs(deltaY)) {
        gestureDirection = (deltaX < 0) ? "left" : "right";
        swipeToggled = true;
      }
      const angle = Math.atan2(deltaY, deltaX);
      voiceButton.style.transform = `translate(-50%, 0) translate(${20 * Math.cos(angle)}px, ${20 * Math.sin(angle)}px)`;
    }

    voiceButton.addEventListener("mousedown", function(e) {
      startX = e.pageX;
      startY = e.pageY;
      swipeToggled = false;
      gestureStartTime = Date.now();
      gestureDirection = "";
      e.preventDefault();
    });
    voiceButton.addEventListener("touchstart", function(e) {
      startX = e.touches[0].pageX;
      startY = e.touches[0].pageY;
      swipeToggled = false;
      gestureStartTime = Date.now();
      gestureDirection = "";
      e.preventDefault();
    });
    voiceButton.addEventListener("mousemove", function(e) {
      updateButtonPosition(e.pageX, e.pageY);
    });
    // 針對 touchmove 加入 {passive: false} 選項
    voiceButton.addEventListener("touchmove", function(e) {
      updateButtonPosition(e.touches[0].pageX, e.touches[0].pageY);
      e.preventDefault();
    }, {passive: false});
    function endDrag() {
      if (navigator.vibrate) { navigator.vibrate(50); }
      voiceButton.style.transform = "translate(-50%, 0)";
      voiceButton.style.backgroundColor = "red";
      if (gestureDirection === "left") {
        window.location.href = "index.html";
      }
      gestureDirection = "";
      swipeToggled = false;
    }
    voiceButton.addEventListener("mouseup", function(e) { endDrag(); e.preventDefault(); });
    voiceButton.addEventListener("touchend", function(e) { endDrag(); e.preventDefault(); });
  </script>
</body>
</html>